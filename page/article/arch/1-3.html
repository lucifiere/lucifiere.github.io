<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <!-- title -->
    <title>王贤兑的技术博客</title>

    <!-- meta -->
    <meta charset="UTF-8">

    <!-- links -->
    <link rel="stylesheet" type="text/css" media="screen" href="../../../css/style.css">

    <!-- scripts -->

    <!-- IE Hacks -->
    <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
<body class="home blog">

<!-- header -->
<header>
    <div id="light">
        <div class="container_16">
            <h1 class="grid_8" style="font-size: 45px"><a href="../../../index.html">Code Craft Of XD.Wang</a></h1>
            <nav class="grid_8">
                <ul id="menu-menu" class="menu">
                    <li><a href="../../../index.html">主页</a></li>
                    <li><a href="../../../page/list/blog.html">博客</a></li>
                    <li><a href="../../../page/list/me.html">ME</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>
<div class="copyrights">作者：王贤兑</div>

<!-- wrapper -->
<div id="wrapper">
    <div class="container_16">
        <section id="posts" class="prefix_1 grid_9">

            <article>
                <h2>服务路由</h2>
                <p class="info">March 2th, 2017 | by <span><a href="#" rel="author">XD.Wang</a></span> | arch
                </p>
                <div class="time"><p>Mar<br><span>3</span></p></div>

                <p></p>

                <div class="text">
                    <p><img src="../../../images/article/arch/1-2.jpg" height="250" width="510"></p>
                    <h4>注册中心</h4>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当某个服务在集群中有多个实例时，服务调用者需要从多个实例中选择合适的节点获取服务，
                        选择适当服务节点的策略，称作服务路由。在分布式服务框架中，注册中心通过记录服务提供者地址、服务发布相关属性来进行服务的订阅和发布，
                        消费者通过主动查询或被动通知的方式从注册中心得到服务提供者的相关信息，路由行为由注册中心配置，对服务调用者透明，
                        调用者无需了解服务提供者具体在哪。
                    </p>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务中心和服务提供者维持有一条长连接，提供者讲地址和属性列表发送给注册中心，
                        服务消费者根据接口名等信息，从注册中心拿到提供者列表和相应信息，缓存到本地。当服务提供者发生变动时，比如下线、宕机、新增，
                        注册中心都会将相应的变动推送给服务调用者，更新本地缓存。</p>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样的方案的好处如下：
                    </p>
                    <ul>
                        <li><b>缓存：</b>省去了每次调用的请求、提高性能；</li>
                        <li><b>高可用：</b>注册中心宕机、暂时不影响服务调用；</li>
                    </ul>
                    <h4>负载均衡</h4>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务路由的重要目的之一就是负载均衡，常见策略有随机算法、轮询、一致性哈希、时延控制轮询、粘滞连接等。</p>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;随机算法：随机路由。实施简单，但各台机器服务能力不同时，无法做到负载均衡，算法实现可用Random类或者SecurityRandom类</p>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;轮询：为每个机器设置权重，依次分派任务。</p>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;时延控制轮询：时延控制轮询是轮询的加强版，轮询可能造成的问题是：不同机器处理处理服务的时延不同，时延大的机器可能造成请求阻塞。
                        时延控制轮询可以动态计算每个机器的服务时延，根据计算结果动态修改权重，避免普通轮询带来的问题，防止请求堆积</p>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;粘滞连接：当服务是有状态的，每次服务必须要落到同一个提供者机器，这种情况叫粘滞连接。</p>

                    <ul>
                        <li><b>IO多路复用：</b></li>
                        <li>IO多路复用将几个IO阻塞转移到同一个Selector上，通过记录各个sock的状态来管理流，使得系统在单线程的情况下也可处理多个请求，
                            提高服务器的吞吐量。
                        </li>
                        <li>具体细节参考大牛罗志宇的讲解 https://www.zhihu.com/question/32163005/answer/55772739</li>
                    </ul>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Java从1.4版本开始，推出了NIO来解决高负载、高并发的IO场景。
                        JDK通过epoll来代替传统的select，支持通过一个线程来接入上万个客户端。</p>
                    <p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最后，在开发通信框架前，需要明确使用的工具。作为一个中间件开发者，
                        理论上应该熟悉java.nio的使用、高并发编程模型（比如reactor模型、actor模型等）以及架构设计模式。但实际上，
                        能达到如此水平的程序员并非很多，为了降低开发难度，提升开发效率，多数企业选择使用Netty、Mina等框架来做进一步开发。</p>

                    <h4>可靠性</h4>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;简而言之，可靠性是通信框架在遭遇故障时的应对能力。
                    </p>
                    <ul>
                        <li><b>故障示例：</b></li>
                        <li>单通：一般由物理故障引起，用只能接收到自己发出去的信号</li>
                        <li>防火墙故障：非法阻止连接进入</li>
                        <li>异常GC：垃圾收集时间过长，通信中断</li>
                    </ul>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以上故障都会导致链路不可用，从而引发业务失败或超时。为了及时发现链路故障，需要通过
                        心跳检测机制来检测链路的可用性，心跳检测一般在三个层次上进行：
                    </p>
                    <ol>
                        <li>
                            TCP层：通过TCP的Keep-Alive机制，监测整个TCP协议栈运行情况。Keep-Alive机制解读：http://www.blogjava.net/yongboy/archive/2015/04/14/424413.html
                        </li>
                        <li>长连接协议：CMPP、MQTT、SMPP等</li>
                        <li>应用层：自定义心跳检测方式</li>
                    </ol>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;心跳机制的原理很简单，一种方式是：发送者发送ping信息给接受者，接收者返回pong信息给发送者，
                        若发送者收不到响应，或者接收者收不到请求，则检测失败，显然，这是一种单向的过程；另一种方式不区分发送者和接收者，
                        两方都按照固定的时间间隔给彼此发送ping信息，当读取或接受过程中发生了IO异常，则检测失败。Netty采用链路空闲检测的方式来做心跳校验，
                        当它检测到链路在单位时间内未发送或接受到任何信息时，断定失败。
                    </p>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务器心跳检测失败时，服务器断开连接，等待客户端重连。客户端心跳检测失败时，客户端断开连接，
                        在间隔一段时间后（保证两端资源的释放），重新连接服务端。可能引起链路断开的情况：
                    </p>
                    <ol>
                        <li>服务器主动断开</li>
                        <li>服务器宕机</li>
                        <li>心跳检测失败</li>
                        <li>链路故障</li>
                    </ol>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;链路断开时，消息框架中的消息队列可能积压有未发出的消息。异步框架发送消息时会先将消息
                        写入队列中，待reactor线程处理后方得处理。因此，如有需要应考虑消息缓存重发。
                    </p>
                    <p>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通信框架退出时，需要注意资源释放问题，可能包括连接池、消息队列、socket、多路复用器等。
                    </p>
                </div>
                <div class="clear"></div>
            </article>

        </section>

        <aside class="prefix_1 grid_5">

            <!-- Categories-->
            <h4>Categories</h4>
            <ul class="categories">
                <li><a href="../../../page/list/lang.html">语言</a></li>
                <li><a href="../../../page/list/algorithm.html">算法</a></li>
                <li><a href="../../../page/list/framework.html">框架</a></li>
                <li><a href="../../../page/list/database.html">数据库</a></li>
                <li><a href="../../../page/list/arch.html">架构</a></li>
                <li><a href="../../../page/list/jvm.html">虚拟机</a></li>
            </ul>
            <div class="clear"></div>
            <hr>

            <!-- article -->
            <h4>Articles</h4>
            <ul class="blogroll">
                <li><a href="../../../page/article/database/1-1.html">MySql性能优化</a></li>
                <li><a href="../../../page/article/database/1-2.html">Binary Log简介</a></li>
                <li><a href="../../../page/article/arch/1-1.html">分布式服务框架概述</a></li>
                <li><a href="../../../page/article/arch/1-2.html">通信框架设计：技术选型和可靠性</a></li>
                <li><a href="../../../page/article/bigdata/1-1.html">Spark快速入门</a></li>
                <li><a href="../../../page/article/jvm/1-1.html">JVM基础知识概述</a></li>
                <li><a href="../../../page/article/lang/1-2.html">理解Java线程池</a></li>
                <li><a href="../../../page/article/bigdata/1-3.html">Spark任务执行的基本原理</a></li>
                <li><a href="#">最近发布</a></li>
                <li><a href="#">最近发布</a></li>
                <li><a href="#">最近发布</a></li>
                <li><a href="#">最近发布</a></li>
                <li><a href="#">最近发布</a></li>
                <li><a href="#">最近发布</a></li>
            </ul>
            <hr>

        </aside>
    </div>
</div>

<!-- footer -->
<footer>
    <section id="footer_content">
        <div class="container_12">

        </div>
    </section>
    <section id="powered">
        <div class="container_12">
            <p class="grid_10"> code craft by <a href="https://lucifiere.github.io/"
                                                 title="王贤兑的博客" target="_blank"> XD.Wang </a></p>
            <p class="grid_2"><a class="top" href="#">▲ Back to top</a></p>
        </div>
    </section>
</footer>
</body>
</html>